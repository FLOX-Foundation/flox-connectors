cmake_minimum_required(VERSION 3.20)
project(flox-connectors LANGUAGES CXX VERSION 0.1.0)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

option(ENABLE_DEV_SETUP "Install pre-commit hook" OFF)

if(ENABLE_DEV_SETUP)
  message(STATUS "Developer setup enabled")

  set(PRECOMMIT_SRC "${CMAKE_CURRENT_SOURCE_DIR}/scripts/pre-commit")
  set(PRECOMMIT_DST "${CMAKE_CURRENT_SOURCE_DIR}/.git/hooks/pre-commit")

  if(EXISTS "${PRECOMMIT_SRC}")
    execute_process(COMMAND ${CMAKE_COMMAND} -E copy_if_different
      "${PRECOMMIT_SRC}" "${PRECOMMIT_DST}")
    execute_process(COMMAND chmod +x "${PRECOMMIT_DST}")
    message(STATUS "Installed pre-commit hook to .git/hooks")
  else()
    message(WARNING "pre-commit script not found at ${PRECOMMIT_SRC}")
  endif()
endif()

option(BUILD_TESTS "Build tests" OFF)

find_package(OpenSSL  REQUIRED)
find_package(ZLIB     REQUIRED)
find_package(CURL     REQUIRED)

set(USE_TLS      ON  CACHE BOOL "Enable TLS support in ixwebsocket" FORCE)
set(USE_OPEN_SSL ON  CACHE BOOL "Use OpenSSL backend"               FORCE)
set(USE_ZLIB     ON  CACHE BOOL "Use zlib in ixwebsocket"           FORCE)

add_subdirectory(external/flox)
add_subdirectory(external/simdjson)
add_subdirectory(external/ixwebsocket)

file(GLOB_RECURSE FLOX_CONNECTORS_SRC CONFIGURE_DEPENDS src/*.cpp)

add_library(flox-connectors STATIC ${FLOX_CONNECTORS_SRC})

target_include_directories(flox-connectors
  PUBLIC  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
          $<INSTALL_INTERFACE:include>
)

target_link_libraries(flox-connectors
  PUBLIC  flox::flox
          simdjson::simdjson
          ixwebsocket
  PRIVATE OpenSSL::SSL OpenSSL::Crypto ZLIB::ZLIB CURL::libcurl pthread
)

include(GNUInstallDirs)

install(TARGETS flox-connectors
        EXPORT  flox-connectorsTargets
        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
        RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})

install(DIRECTORY include/ DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})

install(EXPORT flox-connectorsTargets
        NAMESPACE flox::
        FILE flox-connectors-config.cmake
        DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/flox-connectors)

option(FLOX_CONNECTORS_BUILD_TESTS "Build connectors tests" ON)
if(FLOX_CONNECTORS_BUILD_TESTS)
    enable_testing()
    add_subdirectory(external/googletest)
    add_subdirectory(tests)
endif()
